{{- $architecture := or .architecture "arm64" -}}
{{- $firmware_version := or .firmware_version "master" -}}
{{ $suite :=  or .suite "focal" }}
{{- $image := or .image "ovos-dev-edition-rpi4.img" -}}

architecture: {{ $architecture }}

actions:
  - action: overlay
    description: OVOS specific overlay
    source: ../overlays/mycroft

  - action: download
{{ if eq $architecture "armhf" }}
    url: https://github.com/forslund/mycroft-desktop-repo/raw/gh-pages/pool/main/m/mimic/mimic_1.3.0.1_armhf.deb
{{ else }}
    url: http://downloads.openvoiceos.com/mimic-arm64_1.2.0.2%2B1559651054-1.deb
{{end}}
    name: mimic
    filename: mimic.deb

  - action: overlay
    origin: mimic
    source: .
    destination: /var/tmp/mimic.deb
    
  - action: apt
    description: Mycroft runtime dependencies
    packages:
      - pcre2-utils
      - portaudio19-dev
      - jq
      - mpg123
      - libfann-dev
      - flac
      - breeze-icon-theme
      - python3
      - python3-dev
      - python3-setuptools
      - python3-pip
      - python-is-python3
      - python3-sdnotify
      - libtool
      - libffi-dev
      - libssl-dev
      - autoconf
      - automake
      - bison
      - swig
      - libglib2.0-dev
      - curl
      - libicu-dev
      - pkg-config
      - libjpeg-dev
      - build-essential
      - pulseaudio
      - pulseaudio-utils
      - libpulse-dev
      - wireless-tools
      - dnsmasq
      - sox

  - action: run
    description: Set up user account
    chroot: true
    script: ../scripts/02-setup_mycroft_user.sh

    # Mycroft packages
  - action: apt
    description: Mycroft packages
    packages:
      - python3-pip
      - git-core
      - g++
      - cmake
      - extra-cmake-modules
      - gettext
      - pkg-config
      - mycroft-gui
      - mycroft-embedded-shell
      - qml-module-org-kde-lottie
      - qml-module-qtquick-shapes
      - qml-module-qt-labs-folderlistmodel
      - qml-module-qtquick-particles2
      - qml-module-qtquick-templates2
      - qml-module-qtquick-xmllistmodel
      - qml-module-qtquick-localstorage
      - qml-module-qmltermwidget
      - qml-module-qttest
      - qml-module-qtlocation
      - qml-module-qtpositioning
      - qml-module-qtwebengine
      - qml-module-qtwebchannel
      - qml-module-qtmultimedia
      - qt5ct
      - qml-module-qtquick-virtualkeyboard
      - qtvirtualkeyboard-plugin

  - action: run
    description: Install mycroft base software
    chroot: true
    script: ../scripts/92-pip-mycroft.sh

  - action: download
    description: Download Noto Sans Font
    url: https://noto-website-2.storage.googleapis.com/pkgs/NotoSansDisplay-hinted.zip
    name: noto-sans-display
    filename: NotoSansDisplay-hinted.zip
    unpack: true
    compression: zip

  - action: overlay
    description: Install fonts into filesystem
    origin: noto-sans-display
    source: .
    destination: /usr/share/fonts/truetype/noto

  - action: run
    description: Set font permissions
    chroot: true
    command: chmod +r /usr/share/fonts/truetype/noto/*

  - action: run
    description: Update font cache
    chroot: true
    command: fc-cache -f -v

  - action: overlay
    description: OVOS specific overlay
    source: ../overlays/ovos
